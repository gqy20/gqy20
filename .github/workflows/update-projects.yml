name: Update Projects List

on:
  # æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹è¿è¡Œ
  schedule:
    - cron: '0 18 * * *'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch: {}
  # å½“æœ‰æ–°pushæ—¶è§¦å‘ï¼ˆå¯é€‰ï¼‰
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/update-projects.yml'

permissions:
  contents: write

jobs:
  update-projects:
    runs-on: ubuntu-latest
    name: æ›´æ–°é¡¹ç›®åˆ—è¡¨

    steps:
      - uses: actions/checkout@v6.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get repository list and update README
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;

  
            // è·å–ç”¨æˆ·çš„æ‰€æœ‰ä»“åº“ï¼ˆä½¿ç”¨å…¬å¼€APIï¼‰
            const repos = await github.rest.repos.listForUser({
              username: owner,
              type: 'owner',
              sort: 'updated',
              direction: 'desc',
              per_page: 100
            });

            // è¿‡æ»¤å¹¶å¤„ç†é¡¹ç›®
            const filteredRepos = repos.data
              .filter(r => !r.fork && r.name !== repo)
              .slice(0, 6); // å–6ä¸ªé¡¹ç›®ï¼Œæ¯è¡Œ3ä¸ª

            // ç”Ÿæˆæ¯ä¸ªé¡¹ç›®çš„å¡ç‰‡
            const projectCards = filteredRepos.map(r => {
              const lang = r.language || '';
              // ä½¿ç”¨ skillicons æ˜¾ç¤ºæŠ€èƒ½ï¼ˆç§»é™¤ theme å‚æ•°ï¼‰
              const icon = lang.toLowerCase();
              const skillIcons = icon ? `<img src="https://skillicons.dev/icons?i=${icon}" alt="${lang}" />` : '';

            const stars = r.stargazers_count || 0;
            // é™åˆ¶æè¿°é•¿åº¦
            const description = (r.description || `${r.name} é¡¹ç›®`).substring(0, 50) + (r.description && r.description.length > 50 ? '...' : '');

            // ä½¿ç”¨ GitHub Shields å¾½ç« ä»£æ›¿å›¾ç‰‡å¡ç‰‡
            const projectCard = '<td align="center" width="50%" style="padding: 15px; border: 1px solid #30363d; border-radius: 6px; margin: 5px; background-color: #0d1117;">' +
                '<h3><a href="' + r.html_url + '" style="color: #58a6ff; text-decoration: none;">' + r.name + '</a></h3>' +
                '<p style="color: #8b949e; font-size: 14px; margin: 10px 0;">' + description + '</p>' +
                '<div style="margin: 10px 0;">' + skillIcons + '</div>' +
                '<div style="margin: 10px 0;">' +
                  '<img src="https://img.shields.io/github/stars/gqy20/' + r.name + '?style=flat-square&logo=github" alt="Stars" /> ' +
                  '<img src="https://img.shields.io/github/forks/gqy20/' + r.name + '?style=flat-square&logo=github" alt="Forks" /> ' +
                  '<img src="https://img.shields.io/github/languages/top/gqy20/' + r.name + '?style=flat-square" alt="Language" />' +
                '</div>' +
                (r.homepage ? '<div style="margin-top: 10px;"><a href="' + r.homepage + '" target="_blank" style="color: #58a6ff;">ğŸ  æŸ¥çœ‹æ¼”ç¤º</a></div>' : '') +
                '</td>';

              return projectCard;
            });

            // å°†é¡¹ç›®åˆ†ç»„ï¼Œæ¯ä¸¤ä¸ªä¸€ç»„ï¼ˆæ›´å¥½çš„ç§»åŠ¨ç«¯æ˜¾ç¤ºï¼‰
            const projectRows = [];
            for (let i = 0; i < projectCards.length; i += 2) {
              const rowProjects = [
                projectCards[i] || '<td width="50%"></td>',
                projectCards[i + 1] || '<td width="50%"></td>'
              ];
              projectRows.push('<tr>\n' + rowProjects.join('\n') + '\n</tr>');
            }

            const projectsTable = '<table width="100%" style="table-layout: fixed;">\n' + projectRows.join('\n') + '\n</table>';

            // è¯»å–READMEæ–‡ä»¶
            const fs = require('fs');
            let readme = fs.readFileSync('README.md', 'utf8');

            // æŸ¥æ‰¾å¹¶æ›¿æ¢é¡¹ç›®éƒ¨åˆ†
            const startMarker = '## ğŸŒŸ ç²¾é€‰é¡¹ç›®';
            const endMarker = '### ğŸ¯ Profile Summary';

            const startIndex = readme.indexOf(startMarker);
            const endIndex = readme.indexOf(endMarker);

            if (startIndex !== -1 && endIndex !== -1) {
              const beforeProjects = readme.substring(0, startIndex);
              const afterProjects = readme.substring(endIndex);

              // æ„å»ºæ–°çš„é¡¹ç›®éƒ¨åˆ†
              const projectsSection = startMarker + '\n\n' +
                '<!-- æ­¤éƒ¨åˆ†ç”±GitHub Actionsè‡ªåŠ¨æ›´æ–°ï¼Œè¯·å‹¿æ‰‹åŠ¨ç¼–è¾‘ -->\n' +
                '<!-- ä¸Šæ¬¡æ›´æ–°æ—¶é—´: ' + new Date().toLocaleString('zh-CN') + ' -->\n\n' +
                projectsTable + '\n\n';

              // å†™å…¥æ–°å†…å®¹
              const newReadme = beforeProjects + projectsSection + afterProjects;
              fs.writeFileSync('README.md', newReadme);

              console.log('æˆåŠŸæ›´æ–°äº† ' + filteredRepos.length + ' ä¸ªé¡¹ç›®çš„ä¿¡æ¯');
            } else {
              console.error('æ— æ³•æ‰¾åˆ°é¡¹ç›®éƒ¨åˆ†çš„æ ‡è®°');
              process.exit(1);
            }

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          # åªæœ‰å½“æœ‰å˜æ›´æ—¶æ‰æäº¤
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git pull --rebase || true
            git commit -m "è‡ªåŠ¨åŒæ­¥é¡¹ç›®ä¿¡æ¯"
            git push
          fi