name: Update Projects List

on:
  # æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹è¿è¡Œ
  schedule:
    - cron: '0 18 * * *'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch: {}
  # å½“æœ‰æ–°pushæ—¶è§¦å‘ï¼ˆå¯é€‰ï¼‰
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/update-projects.yml'

permissions:
  contents: write

jobs:
  update-projects:
    runs-on: ubuntu-latest
    name: æ›´æ–°é¡¹ç›®åˆ—è¡¨

    steps:
      - uses: actions/checkout@v6.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get repository list and update README
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;

            // è·å–ç”¨æˆ·çš„æ‰€æœ‰ä»“åº“ï¼ˆä½¿ç”¨å…¬å¼€APIï¼‰
            const repos = await github.rest.repos.listForUser({
              username: owner,
              type: 'owner',
              sort: 'updated',
              direction: 'desc',
              per_page: 100
            });

            // è¿‡æ»¤å¹¶å¤„ç†é¡¹ç›®
            const filteredRepos = repos.data
              .filter(r => !r.fork && r.name !== repo)
              .slice(0, 9); // å–9ä¸ªé¡¹ç›®ï¼Œæ¯è¡Œ3ä¸ª

            // ç”Ÿæˆæ¯ä¸ªé¡¹ç›®çš„å¡ç‰‡
            const projectCards = filteredRepos.map(r => {
              // ç”ŸæˆæŠ€èƒ½å›¾æ ‡
              const languageIcons = {
                'Python': 'py',
                'JavaScript': 'js',
                'TypeScript': 'ts',
                'Java': 'java',
                'HTML': 'html',
                'CSS': 'css',
                'C++': 'cpp',
                'Go': 'go',
                'Rust': 'rust',
                'R': 'r',
                'Shell': 'bash',
                'Docker': 'docker'
              };

              const lang = r.language || '';
              const icon = languageIcons[lang] || lang.toLowerCase();
              const skillIcons = icon ? `![${lang}](https://skillicons.dev/icons?i=${icon}&theme=light&perline=1)` : '';

              const stars = r.stargazers_count || 0;
              const description = r.description || `${r.name} é¡¹ç›®`;

              const projectCard = '<td align="center" width="33%">' +
                '<a href="' + r.html_url + '">' +
                  '<img src="https://github-readme-stats.vercel.app/api/pin/?username=gqy20&repo=' + r.name + '&theme=vue-dark&hide_border=true&show_owner=true" alt="' + r.name + '" width="100%"/>' +
                '</a>' +
                '<p>' +
                  '<strong>' + r.name + '</strong><br/>' +
                  '<em>' + description + '</em><br/>' +
                  skillIcons + '<br/>' +
                  '<code>â­ ' + stars + ' | ğŸ´ ' + (r.forks_count || 0) + ' | ' + (lang || 'å¤šè¯­è¨€') + '</code><br/>' +
                  '<small>ğŸ“… ' + new Date(r.updated_at).toLocaleDateString('zh-CN') + '</small>' +
                  (r.homepage ? '<br/><a href="' + r.homepage + '" target="_blank">ğŸ  æ¼”ç¤º</a>' : '') +
                '</p>' +
                '</td>';

              return projectCard;
            });

            // å°†é¡¹ç›®åˆ†ç»„ï¼Œæ¯ä¸‰ä¸ªä¸€ç»„
            const projectRows = [];
            for (let i = 0; i < projectCards.length; i += 3) {
              const rowProjects = [
                projectCards[i] || '<td></td>',
                projectCards[i + 1] || '<td></td>',
                projectCards[i + 2] || '<td></td>'
              ];
              projectRows.push('<tr>\n' + rowProjects.join('\n') + '\n</tr>');
            }

            // æ„å»ºè¡¨æ ¼
            const projectsTable = '<table width="100%">\n' + projectRows.join('\n') + '\n</table>';

            // è¯»å–READMEæ–‡ä»¶
            const fs = require('fs');
            let readme = fs.readFileSync('README.md', 'utf8');

            // æŸ¥æ‰¾å¹¶æ›¿æ¢é¡¹ç›®éƒ¨åˆ†
            const startMarker = '## ğŸŒŸ ç²¾é€‰é¡¹ç›®';
            const endMarker = '## ğŸ› ï¸ æŠ€èƒ½æ ˆ';

            const startIndex = readme.indexOf(startMarker);
            const endIndex = readme.indexOf(endMarker);

            if (startIndex !== -1 && endIndex !== -1) {
              const beforeProjects = readme.substring(0, startIndex);
              const afterProjects = readme.substring(endIndex);

              // æ„å»ºæ–°çš„é¡¹ç›®éƒ¨åˆ†
              const projectsSection = startMarker + '\n\n' +
                '<!-- æ­¤éƒ¨åˆ†ç”±GitHub Actionsè‡ªåŠ¨æ›´æ–°ï¼Œè¯·å‹¿æ‰‹åŠ¨ç¼–è¾‘ -->\n' +
                '<!-- ä¸Šæ¬¡æ›´æ–°æ—¶é—´: ' + new Date().toLocaleString('zh-CN') + ' -->\n\n' +
                projectsTable + '\n\n';

              // å†™å…¥æ–°å†…å®¹
              const newReadme = beforeProjects + projectsSection + afterProjects;
              fs.writeFileSync('README.md', newReadme);

              console.log('æˆåŠŸæ›´æ–°äº† ' + filteredRepos.length + ' ä¸ªé¡¹ç›®çš„ä¿¡æ¯');
            } else {
              console.error('æ— æ³•æ‰¾åˆ°é¡¹ç›®éƒ¨åˆ†çš„æ ‡è®°');
              process.exit(1);
            }

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          # åªæœ‰å½“æœ‰å˜æ›´æ—¶æ‰æäº¤
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "è‡ªåŠ¨åŒæ­¥é¡¹ç›®ä¿¡æ¯"
            git push
          fi